---
title: "Projet BIO401"
author: "AmigoTeam"
date: "2024-04-07"
output: html_document
---

Partie 1 :

Question biologique : 

Est ce que la résilience des récifs coraliens est suffisante pour lutter contre les facteur de stress tels que la surpêche et les ouragans? 

Hypothèse :

Elle est suffisante jusqu'à une certaine limite qui dépend beaucoup de la complexité du corail, le l'effort de pêche et de l'impact aléatoire des ouragans.

Données :  

| Paramètre | Valeur | Définition |
|--|--|--|
| s | 0.49 | Taux de croissance du parrofish par année |
| r | 1,0.8 | Taux de coissance du corail et taux pour lequel le corail remplace le gazon d'algue par année |
| a | 0.1 | Taux pour lequel les macroalgues remplace le corail par année |
| gamma | 1.6,0.8 | Taux pour lequel les macroalgues remplace le gazon d'algue par année |
| d | 0.44 | Taux de mortalité du corail par année |
| Alpha | 1 | Taux de broutage maximale par le parrofish |
| f | variable | Effort de pêche en pourcentage |
| c1,c2 | 3.65,-3.21 | Détermine la relation entre la complexité du corail et la capacité de support du parrofish |
| delta,v | 4.557,0.9877 | Détermine la relation entre la nourriture disponible et la capacité de support du parrofish |
| Beta | 1 | Capacité de support de l'environnement pour le parrofish relatif |
| hG | 0.03 | Rétablissement de la complexité du corail par année |
| hE | 0.01 | Érosion de la complexité du corail par année |
| kmax | 17.745 | Limite supérieure d'abondance des parrofishs |
| F() | 0.0512 + 0.0176*te, 0 | La proportion de la couverture corallienne affectée par un ouragan respectivement fort/moyen et faible |
| G() | 0.5, F, 0.05 | La proportion attendue de rugosité affectée par les impacts des ouragans respectivement fort, moyen et faible |
| mH | 0.8 | Taux de mortalité des macroalgues suite a un ouragan |
| te | varaible | Temps écouler depuis le dernier ouragan en année |
| sigma | 0.05 | Écart maximale de la variabilité des impacts des oragans d'epsilon |
| epsilon | entre 0 et 1 | Variable aléatoire suivant une distribution normale standard qui décrit la composante aléatoire des impacts des oragans sur le corail |

| Variable | Valeur possible | Définition |
|--|--|--|
| R | entre 1 et 3 | Correspond à la rugosité des recif corralien. Où 1 équivaut à une structrue parfaitement lisse et où 3 est un rugosité très pronnoncer rarement atteint qui équivaut a un récif corailien offrant une tres bonne qualité d'habitat. |
| C | entre 0 et 1 | Correspond à la proportion de couverture du paysage par le corail. Où 1 est une couverture complete et où 0 est l'extinction des corail. |
| M | entre 0 et 1 | Correspond à la proportion de couverture du paysage par les macroalgues. Où 1 est une couverture compete et où 0 est l'extinction des macroalgue. |
| Y | entre 0 et 1 | Le gazon d'algue correspond a tout ce qui n'est pas corail et macroalgue. |
| P | entre 0 et 1 | Correspond à la population des parrofishs. Où 1 est lorsque la capacité de support maximale est atteind et où 0 est l'extinction des parrofishs |

Méthode :

La capacité de support de l'environnement prendre en compte l'abondance des algues, qui constituent leur nourriture, ainsi que la qualité de l'habitat K(M + T, R).  
$K(M+T,R) = \frac{(c1R + c2)}{K_{max}}\frac{\delta(M+Y)}{1 + v(M+Y)}$

Modèle :  
$\frac{dM}{dt} = aMC - \frac{\alpha \frac{P}{\beta}M}{M + Y} - \gamma MY$  
$\frac{dC}{dt} = rTC - dC - aMC$  
$\frac{dP}{dt} = sP(1 - \frac{P}{\beta K(M+T,R)} - sfP$  
$\frac{dR}{dt} = h_GC(3-R) - h_E(1-C)(R-1)$  
$\frac{dY}{dt} = 1 - M - C$  

Modèle Nondimentionner:  
$\frac{dM}{dt} = (asMC - \frac{\alpha \frac{P}{\beta}M}{M + Y} - \gamma MY)\frac{1}{s}$  
$\frac{dC}{dt} = (rTC - dC - aMC)\frac{1}{s}$  
$\frac{dP}{dt} = P(1 - \frac{P}{\beta K(M+T,R)} - fP$  
$\frac{dR}{dt} = h_GC(3-R) - h_E(1-C)(R-1)$  
$\frac{dY}{dt} = 1 - M - C$  

Mise en œuvre d'un ouragan stochastique:  
$dC = g_C(C,M,P,R,t)dt - c(F+\sigma \epsilon)dq$  
$dM = g_M(C,M,P,R,t)dt - Mm_Hdq$  
$dP = g_P(C,M,P,R,t)dt$  
$dR = g_R(C,M,P,R,t)dt - (R-1)(G + \sigma \epsilon)dq$  
$dY = 1 - M - C$  
où $g_C(C,M,P,R,t),g_M(C,M,P,R,t),g_P(C,M,P,R,t),g_R(C,M,P,R,t)$ sont des fonctions qui represente le modèle.  
où q est un processus de saut de Poisson avec un taux de saut λ tel que dq = 0 avec une probabilité de 1 - λdt et dq = 1 avec une probabilité de λdt.  

Supposition :
1. Aucun changement dans la température, la chimie de l'eau ou l'élévation du niveau de la mer est significatif sur l'echelle du temps étudier.  
2. Les perturbations ou stresse des récifs coralliens autres que les ouragans, les impacts indirects de la pêche ou la compétition de l'espace avec les macroalgues ne sont pas pris en compte.  
3. L'effort de pêche ont une influence proportionnelement de la dynamique de population parrofishs et est constant pour toute les années de la simulation.  
4. Après un oragan, le gazon d'algues colonise immédiatement tout l'espace libre.  
5. Les ouragans n'ont pas d'effets directs significatifs sur l'abondance ou la croissance des parrofishs.  
6. La distribution des coraux, des algues macroscopiques et des poissons perroquets dans l'espace n'a pas d'impact sur leur dynamique.  

Calcul :

```{r}
# Chargement de librairie
library(deSolve)
library(viridis)
```

```{r}
# Fonction pour le modele deterministe du l'interaction entre le corail, les marcoalgue et les parrofishs.
interaction_coral <- function(t, vars, parms){
  with(as.list(c(parms, vars)), {
    
    Y <- 1 - M - C # dY/dt
    R <- rug
    
    dM <- (a*M*C - P*M/(M+Y) + gamma*M*Y)/s # dM/dt
    dC <- (r*Y*C - d*C - a*M*C)/s  # dC/dt
    dP <- P*(1 - (P/(((ca+cb*R)/kmax)*((delta*(M+Y))/(1+v*(M+Y)))))) - (f)*P # dP/dt
    
    # Résultat
    res <- c(dM=dM, dC=dC, dP=dP)
    return(list(res))
  })
}

# Fonction pour effectuer un simulation du modele
dessinSol <- function(ic=c(M=0.001,C=0.56,P=0.75), 
                       times=seq(1:30),func=interaction_coral, 
                       parms=c(a=0.1,
                               d=0.44,
                               r=1,
                               f=0.2,
                               s=0.49,
                               ca=-(3.21),
                               cb=3.65,
                               kmax=17.745,
                               delta=4.557,
                               v=0.9877,
                               hG=0.03,
                               hE=0.01,
                               gamma = 1.6,
                               rug=2)) {
  soln <- ode(ic, times, func, parms)
  
  return(soln[30,"C"])
}
```


```{r}
# Matrice des valeur finale de la proportion de corail apres "times" ans
coral <- matrix(data = NA, nrow = 41, ncol = 41)

# Boucle sur rugosité
for (i in 1:41) {
  fish <- (i - 1) * (1 / 40)  # Calcul de la valeur de fish
  
  # Boucle sur fish
  for (j in 1:41) {
    rugo <- 1 + (j - 1) * (2 / 40)  # Calcul de la valeur de rugosité
    
    # Appel de la fonction de simulation et mise à jour de la matrice coral
    res <- dessinSol(ic = c(M = 0.001, C = 0.56, P = 0.95),
                      parms = c(a = 0.1, d = 0.44, r = 1, f = fish,
                                s = 0.49, ca = -3.21, cb = 3.65, kmax = 17.745,
                                delta = 4.557, v = 0.9877, hG = 0.03, hE = 0.01,
                                gamma=1.6,rug=rugo))
    
    # Attribut la dominance du corail, des macroalgue ou d'un équilibre apres time ans
    if(res<0.0001){
      color.tag <- 0
    }else if(res<0.45){
      color.tag <- 0.5
    }else{
      color.tag <- 1
    }
    
    coral[j,i] <- color.tag
  }
}
```

```{r}
rug.vec <- c(1.8,2.1,2.4)
fish.vec <- data.frame()
for (j in seq(3,9,by=3)) {
  for (i in 1:50) {
    fish <- (i - 1) * (1 / 50)  # Calcul de la valeur de fish
    res <- dessinSol(ic = c(M = 0.2, C = 0.8, P = 0.75),
                      parms = c(a = 0.1, d = 0.44, r = 1, f = fish,
                                s = 0.49, ca = -3.21, cb = 3.65, kmax = 17.745,
                                delta = 4.557, v = 0.9877, hG = 0.03, hE = 0.01,
                                gamma=0.8,rug=rug.vec[j/3]))
    res2 <- dessinSol(ic = c(M = 0.8, C = 0.2, P = 0.75),
                       parms = c(a = 0.1, d = 0.44, r = 1, f = fish,
                                 s = 0.49, ca = -3.21, cb = 3.65, kmax = 17.745,
                                 delta = 4.557, v = 0.9877, hG = 0.03, hE = 0.01,
                                 gamma=0.8,rug=rug.vec[j/3]))
    fish.vec[i,j-2] <- fish
    fish.vec[i,j-1] <- res
    fish.vec[i,j] <- res2
  }
}

```

Résultat :

```{r}
# Définition des noms de lignes et de colonnes
row_names <- paste(seq(1, 3, by = (2 / 40)))
col_names <- paste(seq(0, 1, by = (1 / 40)))

row.names(coral) <- row_names
colnames(coral) <- col_names

# Créer le graphique avec la matrice en tant que données
image(1:nrow(coral), 1:ncol(coral), t(coral), col = plasma(40),
      xlab = "fishing effort", ylab = "R", main = "Graphique",axes=F);axis(side = 1, at = 1:ncol(coral), labels = col_names);axis(side = 2, at = 1:nrow(coral), labels = row_names)
```

```{r}
par(mfrow=c(1,3))
plot(x = fish.vec[,1], y = fish.vec[,2],type = "l",ylim = c(0,0.7),xlab = "fishing effort", ylab = "Proportion de Corail apres 30 ans", main = paste("Graphique R =", rug.vec[1]))
lines(x = fish.vec[,1], y = fish.vec[,3])

plot(x = fish.vec[,1], y = fish.vec[,5],type = "l",ylim = c(0,0.7),xlab = "fishing effort", ylab = "Proportion de Corail apres 30 ans", main = paste("Graphique R =", rug.vec[2]))
lines(x = fish.vec[,1], y = fish.vec[,6])

plot(x = fish.vec[,1], y = fish.vec[,8],type = "l",ylim = c(0,0.7),xlab = "fishing effort", ylab = "Proportion de Corail apres 30 ans", main = paste("Graphique R =", rug.vec[3]))
lines(x = fish.vec[,1], y = fish.vec[,9])
par(mfrow=c(1,1))
```

Pour construire les graphiques du couvert de corail final moyen et de la rugosité finale moyenne selon la rugosité initiale et l'effort de pêche, nous avons utilisé la fonction suivante. Elle inclut l'incidence aléatoire d'ouragan avec différentes gravités d'impacts définis, et occurant à différentes fréquences moyennes. Les catégories d'impacts sont faibles (1), modérés (2) et importants (3) et les différentes fréquences moyennes sont 1 fois par 9 ans (1/9), une fois par 15 ans (1/15) et une fois par 30 ans (1/30).

```{r}
corailstochastique <- function (R0,f,lambda=1/30,impact=2,dt=1,graph=FALSE){
  #on instaure une étendue de temps
  tmax <- 100
  t <- 0
  #le temps au dernier ouragan
  to <- 0
  
  #on pose les valeurs de départ et les paramètres
  C <- 0.56*0.8
  M <- 0.01
  Y <- 0.43
  R <- R0
  P <- 0.5
  a<-0.1
  g<-0.8
  d<-0.44
  r<-0.8
  f<-f
  s<-0.49
  ca<--(3.21)
  cb<-3.65
  kmax<-17.745
  delta<-4.557
  v<-0.9877
  hG<-0.03
  hE<-0.01
  o <- 0.05
  mH <- 0.8

  #on initie les vecteurs de résultats
  vecC <- C
  vecM <- M
  vecY <- Y
  vecR <- R
  vecP <- P
  
  while (t<tmax){
    
    #on effectue le tirage pour déterminer si il y a ou pas ouragan
    ouragan <- pmin(rpois(1,lambda*dt),1)
    #si oui ou non, on ajuste dq
    if (ouragan==1){
      
      #on calcule le temps depuis le dernier ouragan
      te <- t - to
      
      #on sauve le nouveau temps de dernier ouragan
      to <- t
      
      #on calcule F
      F <- pmin(0.0512 + 0.0176*te, 0.5)
      
      #différents dommage selon valeur d'impact
      if (impact==3){
        #on calcule les dommages d'un fort ouragan
        dommC <- C*(F + o*runif(1))
        dommM <- M*mH
        dommR <- (R-1)*0.5
      }
      if (impact==2){
        #on calcule les dommages d'un moyen ouragan
        dommC <- C*(F + o*runif(1))
        dommM <- M*mH
        dommR <- (R-1)*(F + o*runif(1))
      }
      if (impact==1){
        #on calcule les dommages d'un faible ouragan
        dommC <- 0
        dommM <- M*mH
        dommR <- (R-1)*0.05
      }
    }else{
      dommC <- 0
      dommM <- 0
      dommR <- 0
    }
    
    #on calcule les changements
    dM <- ((a)*M*C - ((1)*P*M/(M+Y)) + (g)*M*Y)*dt - dommM
    dC <- ((r)*Y*C - (d)*C - (a)*M*C)*dt - dommC
    dP <- ((s)*P*(1 - (P/((((ca+cb*R)/kmax)*((delta*(M+Y))/(1+v*(M+Y))))))) -(f*s)*P)*dt 
    dR <- ((hG)*C*(3 - R) - (hE)*(1 - C)*(R - 1))*dt - dommR
    
    #on effectue les changements
    M <- pmax(M + dM,0.0001)
    C <- pmax(C + dC,0.0001)
    Y <- 1 - M - C
    R <- R + dR
    P <- pmax(P + dP, 0.0001)
    
    #on sauve les nouvelles valeurs dans leur vecteurs
    vecC <- c(vecC,C)
    vecM <- c(vecM,M)
    vecY <- c(vecY,Y)
    vecR <- c(vecR,R)
    vecP <- c(vecP,P)
    
    #on fait avancer le temps
    t <- t + dt
  }
  #si on veut afficher les graphiques, on met TRUE à l'argument graph = 
  if (graph==TRUE){
    #on affiche le premier plot, avec la trajectoire du corail
    plot(seq(0,tmax,length.out = length(vecC)),vecC, type="l", col="red", ylim=c(0,1), 
         xlab= "temps", ylab="valeurs")
    #on ajoute un axe secondaire pour la rugosité
    axis(side = 4,at= seq(0,1,0.1),labels = seq(1,3,0.2), )
    mtext("rugosité", side = 4, line = 2, col = "black", cex = 1)
    #on affiche les différentes lignes
    lines(seq(0,tmax,length.out = length(vecM)),vecM, col="blue")
    lines(seq(0,tmax,length.out = length(vecP)),vecP, col="green")
    lines(seq(0,tmax,length.out = length(vecR)),(vecR-1)/2, col="orange")
    #on ajoute une légende
    legend("topright", legend = c("corail", "macroalgues","poissons","rugosité"),
           col = c("red","blue","green","orange"), lty = c(1, 1),
           lwd = 1.75, bg = "white",cex = 0.65)
  }
  #on affiche le résultat final du couvert de corail ainsi que de la rugosité
  return(c(tail(vecC,1),tail(vecR,1)))
}

#exemple
par(mfrow=c(1,1),mar=c(4,4.5,2,4))
corailstochastique(R0=2.2, f= 0.5, lambda = 1/15,impact = 2,dt=0.1,graph = T)

```

On peut ensuite construire les graphiques du couvert de corail final moyen ainsi que l'écart-type pour un éventail de rugosité initiale entre 1 et 3 et d'effort de pêche entre 0 et 1. La fonction utilisée pour cela est la suivante:

```{r}
library(fields)
graph.imageC <- function(impact,freq,it=10,pas=0.1){
  #on initie une matrice pour les moyennes et une autre pour les écarts-types
  #pour des images de 21 pixels de hauteur et 26 de largeur
  matC <- matrix(0, nrow = 21,ncol = 26)
  matsd <- matrix(0, nrow = 21,ncol = 26)

  #on fixe les variables constantes
  imp<-impact
  l<-freq
  #Les boucles suivantes font essayer différentes valeurs de R0 et de f
  for (i in 1:21) {
    for (j in 1:26){
      #on amorce un vecteur pour contenir les résultats de chaque réplicat
      res <- vector(length = 0)
      #la boucle pour it nombre de réplicat
      for (z in 1:it) {
        #on calcule R0 et f
        R1 <- i*0.1+0.9
        f0 <- j*0.04-0.04
        #le résultat pour le couvert de corail est [1]
        w <- corailstochastique(R0=R1,f=f0, lambda = l,impact = imp,dt=pas, graph = F)[1]
        res<-c(res,w)
      }
      #on entre la moyenne et l'écart-type de la combinaison dans les matrices correspondantes
      matC[i,j]<-mean(res)
      matsd[i,j]<-sd(res)
    }
  }
  
  #on fixe les valeurs pour les axes
  x_values <- seq(0, 1, length.out = ncol(matC))
  y_values <- seq(1, 3, length.out = nrow(matC))
  
  #on affiche les images
  par(mfrow=c(1,2),mar=c(4,4.5,3,5))
  image.plot(x = x_values, y = y_values, t(matC), col = viridis(20), 
             xlab = "effort de pêche", ylab = "Rugosité initiale", 
             main=c("moyenne de C finale",paste(c("fréq:1/",1/l,", impact:",imp),collapse = "")))
  image.plot(x = x_values, y = y_values, t(matsd), col = viridis(20),
             xlab = "effort de pêche", ylab = "Rugosité initiale",
             main=c("moyenne de C finale",paste(c("fréq:1/",1/l,", impact:",imp),collapse = "")))
}
```
On peut ainsi visualiser le résultat pour les 2 situations suivantes, par exemple: la simulation avec ouragans à impacts modérés (2) d'une fréquence faible (30 ans) et la simulation avec ouragans à impacts modérés (2) d'une fréquence élevée:

```{r, fig.dim=c(12,5)}
graph.imageC(2,1/30,10,1)
graph.imageC(2,1/9,10,1)

```

Idem pour la moyenne ainsi que l'écart-type de la rugosité. La fonction utilisée pour cela est la suivante (ce sont les mêmes étapes que pour graph.imageC, seulement avec [2] pour obtenir la rugosité finale pour `corailstochastique()`, les étapes ne sont donc pas commentées) et les 2 mêmes simulations sont montrées à la fin:

```{r,fig.dim=c(12,5)}
graph.imageR <- function(impact,freq,it=10,pas=0.1, graph=T, max=F){
  
  matC <- matrix(0, nrow = 21,ncol = 26)
  matsd <- matrix(0, nrow = 21,ncol = 26)

  imp<-impact
  l<-freq
  for (i in 1:21) {
    for (j in 1:26){
      res <- vector(length = 0)
      for (z in 1:it) {
        R1 <- i*0.1+0.9
        f0 <- j*0.04-0.04
        w <- corailstochastique(R0=R1,f=f0, lambda = l,impact = imp,dt=pas, graph = F)[2]
        res<-c(res,w)
      }
      matC[i,j]<-mean(res)
      matsd[i,j]<-sd(res)
    }
  }
  #si on veut afficher les images
  if (graph==TRUE){
    x_values <- seq(0, 1, length.out = ncol(matC))
    y_values <- seq(1, 3, length.out = nrow(matC))
    # Plot the matrix as an image with different colored pixels
  
    par(mfrow=c(1,2),mar=c(4,4.5,3,5))
    image.plot(x = x_values, y = y_values, t(matC), col = viridis(20), 
               xlab = "effort de pêche", ylab = "Rugosité initiale", 
               main=c("moyenne de R finale",paste(c("fréq:1/",1/l,", impact:",imp),
                                                  collapse = "")))
    image.plot(x = x_values, y = y_values, t(matsd), col = viridis(20),
               xlab = "effort de pêche", ylab = "Rugosité initiale",
               main=c("moyenne de R finale",paste(c("fréq:1/",1/l,", impact:",imp),
                                                  collapse = "")))
  }
  #si on veut afficher la moyenne
  if (max==T){ 
    print(max(matC))
  }
}

graph.imageR(2,1/30,10,1)
graph.imageR(2,1/9,10,1)

```

On peut ensuite bâtir un graphique avec la valeur maximale de rugosité finale pour chacune des 9 simulations possibles d'impact et de fréquence variées:

```{r}

```


Interprétation : 
